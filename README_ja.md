# mfdirsync - 単一方向ディレクトリ同期ツール

[English](README.md) | [日本語](README_ja.md)

**[重要] このソフトウェアはMITライセンスで配布されており無保証であり、開発者は責任を負いません。詳しくはLICENSEをご確認ください**

**[重要] 開発者が自分で日頃つかって気を付けてはいるつもりですが、使い方が分からない状態で使ったり、そもそも不具合でファイルが消えたりしても保障はできませんので自己責任でご利用ください。**

**[お知らせ] このプロジェクトはプルリク等あっても対応できないかもしれません。全ては開発者がやる気と心と時間の余裕次第です・・・**

## 概要

ディレクトリを同期するためのPythonで書かれたCLIツールです。

同期元ディレクトリから同期先ディレクトリに内容が同じになるようにファイルコピー・削除を行います。　対象となるファイルの拡張子指定も行え、jsonでログを残す機能があります。

以下のサブコマンドがあり同期元から同期先の一方向のディレクトリ内ファイルの同期が行えます。

cp: 同期元ディレクトリにあって同期先ディレクトリにないものと、両方にあるが同期元ディレクトリの方が更新履歴が新しいものを同期先ディレクトリにコピーします

rm: 同期先ディレクトリにあって同期元ディレクトリにないものを削除します

sync: ファイルの最新状態の反映を削除も同時に行いたい場合はこれを使う。cp,rmの順に実行することで同期を行います。

## インストール

先にPythonをインストールします。
Python公式やAnacondaなどお好みの方法でインストールしてください。

Pythonをインストールしたら以下を実行します

```sh
pip install git+https://github.com/mallocfree009/mfdirsync
```

これでmfdirsyncコマンドが利用できるようになります。

## 詳細な使用方法

**[重要] 注意事項:**

同期元ディレクトリのパスが同期先ディレクトリのパスに含まれるような指定（例: `mfdirsync cp ./source ./source/backup`）は、無限ループや予期せぬファイル削除などの問題を引き起こす可能性があるため、**現在ではエラーとして処理され、実行が停止します。** これは `cp`、`rm`、`sync` の全てのサブコマンドに共通する制限です。同期元と同期先は、互いに独立したパスを指定してください。

### コマンドのヘルプ

各コマンドの詳しい使い方やオプションは、`-h` または `--help` オプションで確認できます。

```bash
mfdirsync -h
mfdirsync cp -h
mfdirsync rm -h
mfdirsync sync -h
```

### オプション

*   `-e`, `--extensions <EXT>`: 処理対象とするファイルの拡張子を指定します。複数回指定することで複数の拡張子を対象にできます（例: `-e cs -e txt`）。拡張子には正規表現パターンも利用できます。指定しない場合は全てのファイルを対象とします。
*   `-f`, `--force`: コピー操作において、同期先に同名のファイルが存在する場合でも、更新日時に関わらず強制的に上書きします。
*   `-d`, `--dry-run`: ドライランモードで実行します。実際のファイル操作は行わず、実行される予定の操作をリスト表示します。
*   `-l`, `--log-json [DIR]`: 実際に行ったファイル操作をJSON形式で出力します。ディレクトリパスを指定した場合、そのディレクトリの直下に `dirsync_YYYYMMDD_HHMMSS_ffffff+ZZZZ.json` の形式で日付と時刻を含むファイル名でログが出力されます。ディレクトリパスを指定しない場合（`-l` のみ指定）、カレントディレクトリに出力されます。ドライランモード (`-d`) とは同時に指定できません。
*   `-v`, `--verbose`: 詳細なメッセージ（例: スキップされたファイル）を標準出力に表示します。

### サブコマンド `cp` (Copy)

同期元ディレクトリから同期先ディレクトリへファイルをコピーします。

**機能:**
*   同期元にのみ存在するファイルを同期先に新規コピーします。
*   同期元と同期先の両方に存在するファイルで、同期元の方が更新日時が新しい場合、同期先のファイルを上書きします。
*   `-f` (`--force`) オプションが指定された場合、更新日時に関わらず強制的に上書きします。

**使用例:**

```bash
# .csファイルと.txtファイルを ./my_source から ./my_backup にコピー（新規・更新のみ）
mfdirsync cp ./my_source ./my_backup -e cs -e txt

# 全てのファイルを強制的にコピー（新規・更新・強制上書き）
mfdirsync cp ./project_files ./archive -f

# コピー操作のドライラン（実際にはコピーしない）
mfdirsync cp ./source ./destination -d

# コピー操作をログに記録
mfdirsync cp ./source ./destination -l ./logs

# スキップされたファイルも表示しながらコピー
mfdirsync cp ./source ./destination -v
```

### サブコマンド `rm` (Remove)

同期先ディレクトリに存在するが同期元ディレクトリには存在しないファイルを削除します。

**機能:**
*   同期先ディレクトリ内のファイルのうち、同期元ディレクトリに対応するファイルが存在しないものを削除します。
*   ファイル削除後、空になったディレクトリも削除します。

**使用例:**

```bash
# .csファイルと.txtファイルのうち、./original_data にないものを ./old_backup から削除
mfdirsync rm ./original_data ./old_backup -e cs -e txt

# 削除操作のドライラン（実際には削除しない）
mfdirsync rm ./source ./destination -d

# 削除操作をログに記録
mfdirsync rm ./source ./destination -l ./logs
```

### サブコマンド `sync` (Synchronize)

`cp` コマンドと同様のコピー処理を実行した後、`rm` コマンドと同様の削除処理を実行することで、同期元と同期先を完全に同期します。

**機能:**
*   まず `cp` と同じロジックでファイルをコピー・上書きします。
*   次に `rm` と同じロジックで同期先にのみ存在するファイルを削除します。

**使用例:**

```bash
# .csファイルと.txtファイルを ./project_root と ./synced_copy の間で完全に同期
mfdirsync sync ./project_root ./synced_copy -e cs -e txt

# 全てのファイルを強制的に同期
mfdirsync sync ./source ./destination -f

# 同期操作のドライラン（実際には操作しない）
mfdirsync sync ./source ./destination -d

# 同期操作をログに記録
mfdirsync sync ./source ./destination -l ./logs

# スキップされたファイルも表示しながら同期
mfdirsync sync ./source ./destination -v
```

### JSONログのフォーマット

`-l` または `--log-json` オプションを指定すると、実行されたファイル操作の詳細がJSON形式で出力されます。

**出力例:**

```json
{
    "app": "mfdirsync",
    "version": 1,
    "timestamp": "2023-10-27T10:30:00.123456+09:00",
    "cmd": ["sync", "source_dir", "dest_dir", "-e", "cs"],
    "subcmd": "sync",
    "summary": {
        "cp": 5,
        "cpu": 2,
        "rm": 3,
        "rmdir": 1,
        "skip": 10
    },
    "actions": [
        {"type": "cp", "path": "path/to/new_file.cs"},
        {"type": "cpu", "path": "path/to/updated_file.cs"},
        {"type": "rm", "path": "path/to/deleted_file.txt"},
        {"type": "rmdir", "path": "path/to/empty_dir"}
    ]
}
```

**フィールドの説明:**

*   `app`: アプリケーション名 (`mfdirsync`)。
*   `version`: ログフォーマットのバージョン。
*   `timestamp`: 操作が実行された日時（ISO 8601形式、タイムゾーン情報付き）。
*   `cmd`: 実行されたコマンドライン引数のリスト。
*   `subcmd`: 実行されたサブコマンド (`cp`, `rm`, `sync`)。
*   `summary`: 各アクションタイプごとの発生回数を集計したサマリー。
    *   `cp`: 新規コピーされたファイル数。
    *   `cpu`: 更新日時が新しいため上書きコピーされたファイル数、または強制上書きされたファイル数。
    *   `rm`: 削除されたファイル数（ドライランの場合は削除予定のファイル数も含む）。
    *   `rmdir`: 削除された空のディレクトリ数（ドライランの場合は削除予定のディレクトリ数も含む）。
    *   `skip`: スキップされたファイル数（`cp` コマンドで更新日時が同じか古いファイル）。このタイプは `actions` リストには含まれませんが、サマリーには含まれます。
*   `actions`: 実行された個々のファイル操作のリスト。`skip` タイプのアクションはここには含まれません。
    *   `type`: 操作の種類 (`cp`, `cpu`, `rm`, `rmdir`)。
    *   `path`: ベースディレクトリからの相対パス。
